<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Landmarks and Audio Control</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }

        .video-container {
            position: relative;
            margin-bottom: 20px;
            width: 640px;
            height: 480px;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            background-color: #2a2a2a;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .button-container {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:active {
            background-color: #3d8b40;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="button-container">
        <button id="toggleLandmarks">Toggle Tracking: OFF</button>
        <button id="playReferenceAudio">Play Reference Guide</button>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const toggleLandmarksButton = document.getElementById('toggleLandmarks');
        const playReferenceAudioButton = document.getElementById('playReferenceAudio');
        const context = canvas.getContext('2d');

        // MediaPipe Face Mesh landmark indices
        const FACEMESH_FACE_OVAL = [
            [389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162]
        ];

        const FACEMESH_LIPS = [
            [61, 146, 91, 181, 84, 17, 314, 405, 321, 375, 291, 308, 324, 318, 402, 317, 14, 87, 178, 88, 95],
            [78, 191, 80, 81, 82, 13, 312, 311, 310, 415, 308, 291, 375, 321, 405, 314, 17, 84, 181, 91, 146]
        ];

        let isTracking = false;
        let playReference = false;

        // WebSocket setup
        const socket = new WebSocket('ws://localhost:8000/ws');

        // Set up video stream
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoElement.srcObject = stream;
            })
            .catch(err => {
                console.error('Error accessing webcam:', err);
            });

        // Handle video metadata loaded
        videoElement.onloadedmetadata = () => {
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
        };

        // Handle window resize
        window.addEventListener('resize', () => {
            if (videoElement.videoWidth) {
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
            }
        });

        function drawLandmarks(faceMesh) {
            if (!faceMesh || faceMesh.length === 0) return;
            
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            const landmarks = faceMesh[0]; // Get first face
            
            // Set drawing style
            context.strokeStyle = 'white';
            context.lineWidth = 2;
            context.fillStyle = 'white';
            
            // Draw face oval
            drawConnectedPoints(landmarks, FACEMESH_FACE_OVAL[0]);
            
            // Draw lips
            FACEMESH_LIPS.forEach(lipPoints => {
                drawConnectedPoints(landmarks, lipPoints);
            });
        }

        function drawConnectedPoints(landmarks, connections) {
            if (!landmarks || !connections) return;
            
            context.beginPath();
            
            // Move to first point
            const firstPoint = landmarks[connections[0]];
            context.moveTo(
                firstPoint.x * canvas.width,
                firstPoint.y * canvas.height
            );
            
            // Connect all points
            for (let i = 1; i < connections.length; i++) {
                const point = landmarks[connections[i]];
                context.lineTo(
                    point.x * canvas.width,
                    point.y * canvas.height
                );
            }
            
            // Close the path for complete shapes
            context.closePath();
            context.stroke();
            
            // Draw points
            connections.forEach(index => {
                const point = landmarks[index];
                context.beginPath();
                context.arc(
                    point.x * canvas.width,
                    point.y * canvas.height,
                    2, 0, 2 * Math.PI
                );
                context.fill();
            });
        }

        // Button event listeners
        toggleLandmarksButton.addEventListener('click', () => {
            isTracking = !isTracking;
            toggleLandmarksButton.textContent = `Toggle Tracking: ${isTracking ? 'ON' : 'OFF'}`;
            socket.send(isTracking ? 'toggle_on' : 'toggle_off');
        });

        playReferenceAudioButton.addEventListener('click', () => {
            playReference = !playReference;
            socket.send(playReference ? 'play_reference' : 'toggle_off');
        });

        // WebSocket message handler
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.faceMesh) {
                drawLandmarks(data.faceMesh);
            }
        };

        // WebSocket connection handlers
        socket.onopen = () => {
            console.log('WebSocket connected');
        };

        socket.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };

        socket.onclose = () => {
            console.log('WebSocket connection closed');
        };
    </script>
</body>
</html>